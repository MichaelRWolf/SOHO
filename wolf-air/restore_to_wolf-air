#! /bin/bash
set -euo pipefail

# Restore selected files from a local Time Machine snapshot on the ORIGINAL Mac
# Sends data to LOANER computer (named 'wolf-air') via rsync over SSH

SNAPSHOT_DATE="2025-03-28-135002"
SNAPSHOT_PATH="/Volumes/com.apple.TimeMachine.${SNAPSHOT_DATE}.local"
BACKUP_SRC_HOME="$SNAPSHOT_PATH/Users/wendy"
DEST_HOME="/Users/wendy"

# Hostnames
RESTORE_HOSTNAME="wolf-air"
BACKUP_HOSTNAME="wendy-pro"
RECOVERY_SRC_HOME="$RESTORE_HOSTNAME.local:$DEST_HOME"

# Dry run mode by default (set to "" to disable)
DRY_RUN_FLAG="--dry-run"

# Precondition: Ensure this script is running on the BACKUP host
CURRENT_HOSTNAME=$(scutil --get LocalHostName)
if [ "$CURRENT_HOSTNAME" != "$BACKUP_HOSTNAME" ]; then
  echo "Error: This script must be run on $BACKUP_HOSTNAME. Current host is $CURRENT_HOSTNAME. Exiting."
  exit 1
fi

# Mount the snapshot
sudo tmutil mountsnapshot / "$SNAPSHOT_DATE"

# Wait for it to show up
if [ ! -d "$SNAPSHOT_PATH" ]; then
  echo "Snapshot did not mount as expected. Exiting."
  exit 1
fi

# Log file
LOGFILE="$HOME/restore_to_loaner_$(date +%Y%m%d_%H%M%S).log"
echo "Restoring from snapshot $SNAPSHOT_DATE to $RESTORE_HOSTNAME" | tee "$LOGFILE"

copy_folder() {
  local folder="$1"
  echo "Copying $folder to LOANER..." | tee -a "$LOGFILE"
  rsync -avh $DRY_RUN_FLAG --progress "$BACKUP_SRC_HOME/$folder" "$RECOVERY_SRC_HOME/" >> "$LOGFILE" 2>&1
}

# Copy desired folders
copy_folder "Desktop"
copy_folder "Documents"
copy_folder "Downloads"
copy_folder "Pictures"
copy_folder "Music"
copy_folder "Movies"

# Mail-specific folders
copy_folder "Library/Mail"
copy_folder "Library/Containers/com.apple.mail"
copy_folder "Library/Preferences/com.apple.mail.plist"

(
echo "Restore completed at $(date). Check $LOGFILE for details."

# Reminder to unmount if needed
echo "To unmount snapshot:"
echo "sudo umount '$SNAPSHOT_PATH'"
) | tee -a "$LOGFILE"
